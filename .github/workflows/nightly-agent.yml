name: nightly-agent

on:
  workflow_dispatch: {}          # run manually from the Actions tab
  schedule:
    - cron: "0 5 * * *"          # daily at 05:00 UTC (≈1:00 AM ET)

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: nightly-agent-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run-agent:
    runs-on: ubuntu-latest
    env:
      # ⬇️ Set in repo Settings → Secrets and variables → Actions
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      # Optional override via secret; otherwise use default below
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}
      # Push the agent to iterate multiple times per run
      AGENT_PASSES: ${{ secrets.AGENT_PASSES || '3' }}

    steps:
      - name: Checkout
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ----- Install & start API (background) -----
      - name: Install server deps
        run: |
          cd server
          npm ci || npm i
      - name: Start API
        run: |
          cd server
          nohup npm run dev >/dev/null 2>&1 &

      # ----- Install app deps -----
      - name: Install app deps
        run: |
          cd app
          npm ci || npm i

      # ----- Python deps for the agent -----
      - name: Install agent deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      # ----- Run the agent (codegen + tests) -----
      - name: Run agent
        run: |
          python agent/m
